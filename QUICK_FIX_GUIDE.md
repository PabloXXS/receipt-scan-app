# üöÄ –ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ–∫–æ–≤

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ß–µ–∫ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ (ProStore –∏ —Ç.–¥.)

## ‚úÖ –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–µ–∫–æ–≤
2. ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
4. ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ö–µ–º—É –ë–î

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```bash
flutter run -d macos
```

### –®–∞–≥ 2: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–µ–∫ –≤ –ù–û–í–£–Æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é

1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "+" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–∞
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —á–µ–∫–∞
3. –í –ø–æ–ª–µ "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" –≤–≤–µ–¥–∏—Ç–µ **–Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ** (–Ω–∞–ø—Ä–∏–º–µ—Ä "–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è")
4. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

#### ‚úÖ –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —É—Å–ø–µ—à–Ω—ã–µ –ª–æ–≥–∏:

```
üîç [RECEIPT_WIZARD] –ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
üîç [RECEIPT_WIZARD] –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞: 0 –∫–∞—Ç–µ–≥–æ—Ä–∏–π
‚ûï [RECEIPT_WIZARD] –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
‚ûï [RECEIPT_WIZARD] –û—Ç–≤–µ—Ç –æ—Ç –ë–î –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏: {id: xxx, ...}
‚úÖ [RECEIPT_WIZARD] –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞. ID: xxx
üìù [RECEIPT_WIZARD] –ß–µ–∫ —Å–æ–∑–¥–∞–Ω. receiptId: yyy
```

**–ó–Ω–∞—á–∏—Ç –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!** –ß–µ–∫ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.

#### ‚ùå –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É:

```
‚ùå [RECEIPT_WIZARD] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è":
PostgrestException(message: new row violates row-level security policy for table "merchants", ...)
```

**–ó–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ —Å RLS –ø–æ–ª–∏—Ç–∏–∫–æ–π** - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –®–∞–≥—É 4.

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –ë–î

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞ `check_policies.sql`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **3 –ø–æ–ª–∏—Ç–∏–∫–∏** –¥–ª—è `merchants`:
   - `Users can view all merchants` (SELECT)
   - `Users can create merchants` (INSERT) ‚ö†Ô∏è –≠—Ç–∞ –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
   - `Users can update merchants` (UPDATE)

### –®–∞–≥ 5: –ï—Å–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ—Ç - –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
supabase migration list --linked

# –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è 0003 –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è:
# –°–±—Ä–æ—Å—å—Ç–µ –ë–î –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–Ω–æ–≤–æ
supabase db reset --linked --yes
```

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï**: `db reset` —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ! –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —Å–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø.

### –®–∞–≥ 6: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–µ–∫ –≤ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –µ—â—ë —Ä–∞–∑.

## üìù –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø–æ–º–æ–≥–ª–∏)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤—Ä—É—á–Ω—É—é –≤ Supabase SQL Editor:

```sql
-- –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è INSERT –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
CREATE POLICY IF NOT EXISTS "Users can create merchants"
ON merchants
FOR INSERT
TO authenticated
WITH CHECK (true);

-- –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è UPDATE –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
CREATE POLICY IF NOT EXISTS "Users can update merchants"
ON merchants
FOR UPDATE
TO authenticated
USING (true)
WITH CHECK (true);
```

## üêõ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:

   ```bash
   supabase status
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª - –µ—Å—Ç—å –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏ Supabase

3. –û—Ç–∫—Ä–æ–π—Ç–µ `DEBUG_RECEIPT_SAVING.md` –¥–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

## üìû –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

–ü—Ä–∏—à–ª–∏—Ç–µ –ª–æ–≥–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `check_policies.sql`.
