# AI-пайплайн

## Поток

1. Клиент загружает изображение чека в приватный бакет (Supabase Storage)
2. Создается запись `files`, черновик `receipts(status=processing)`
3. Edge Function инициирует анализ:
   - **OCR провайдеры:** Tesseract, OpenAI Vision, OCR.space
   - **Текстовый парсер** для извлечения структуры из распознанного текста
   - **Fallback механизм:** если основной метод не дал результата, переключается на резервный
4. Результат маппится в `receipts` + `receipt_items`
5. Статус чека -> `ready` (или `failed` с `error_text`)
6. Клиент пуллит статус / получает push (позже) и показывает данные

## OCR Провайдеры

### 1. Tesseract OCR (Self-hosted)

**Описание:** Микросервис с нативным Tesseract, развернутый отдельно

**Преимущества:**

- **Tesseract полностью бесплатный** (open-source, Apache 2.0)
- Стоимость только за хостинг сервиса (~$0-5/мес на Fly.io)
- Полный контроль над качеством
- Предобработка изображений (grayscale, threshold, sharpen)
- Поддержка русского и английского языков
- При нагрузке до 15,000 чеков/месяц → **бесплатно на Fly.io**

**Недостатки:**

- Требует отдельной инфраструктуры (Docker + деплой)
- Медленнее Vision LLM на сложных чеках
- Нужна дополнительная настройка

**Использование:**

```bash
# Установить переменную окружения
supabase secrets set TESSERACT_OCR_URL=https://your-tesseract-service.com
supabase secrets set AI_PROVIDER=tesseract
```

### 2. OpenAI GPT-4o-mini Vision (Primary)

**Описание:** Мультимодальная LLM, напрямую анализирует изображение

**Преимущества:**

- Высокая точность на сложных чеках
- Не требует OCR (анализирует изображение напрямую)
- JSON Schema для структурированного ответа
- Автоматическое извлечение названия магазина

**Недостатки:**

- Стоимость: ~$0.01-0.02 за чек
- Требует OPENAI_API_KEY

### 3. OCR.space (Fallback)

**Описание:** Внешний OCR API (тоже использует Tesseract)

**Преимущества:**

- Готовый API, не требует настройки
- Бесплатный план: 25,000 запросов/месяц

**Недостатки:**

- Зависимость от внешнего сервиса
- Лимиты на бесплатном плане

## Контракт результата (пример)

```json
{
  "store": "Магазин ABC",
  "store_confidence": 0.85,
  "date": "2025-09-26",
  "time": "14:23:10",
  "currency": "RUB",
  "total": 1250.5,
  "items": [
    { "name": "Молоко 1л", "qty": 1, "price": 89.9 },
    { "name": "Хлеб", "qty": 1, "price": 45.0 }
  ]
}
```

## Улучшения определения названия магазина

### Нормализация названий

- Удаление ООО, ИП, кавычек и лишних символов
- Приведение к единому формату для сравнения
- Обработка различных вариантов написания

### Нечеткое сопоставление

- Алгоритм схожести на основе общих слов
- Порог схожести 0.8 для автоматического сопоставления
- Поиск похожих названий в базе данных

### Оценка уверенности

- Поле `store_confidence` (0-1) в результате анализа
- Визуальные индикаторы в UI для пользователя
- Логика принятия решений на основе уверенности

### Извлечение из шапки чека

- Анализ первых 10 строк чека как потенциальной шапки
- Фильтрация служебной информации (адрес, ИНН, время, дата)
- Сопоставление с магазинами пользователя
- Резервный алгоритм поиска в названиях товаров

### Многоуровневый подход

1. **LLM анализ** - основной метод извлечения названия
2. **Сопоставление с шапкой** - поиск в тексте шапки чека
3. **Резервный алгоритм** - поиск в названиях товаров
4. **Нечеткое сопоставление** - с существующими магазинами

## Fallback стратегия

### Режим: AI_PROVIDER=tesseract

1. **Primary:** Tesseract OCR → текстовый парсер
2. **Fallback:** Если качество низкое → OpenAI Vision

### Режим: AI_PROVIDER=openai (default)

1. **Primary:** OpenAI Vision
2. **Fallback 1:** Если результат слабый → Tesseract
3. **Fallback 2:** Если Tesseract не работает → OCR.space

### Режим: AI_PROVIDER=ocrspace

1. **Primary:** OCR.space → текстовый парсер
2. **Fallback:** Если качество низкое → OpenAI Vision

## Гибридный подход (рекомендуется)

**Оптимальная стратегия:** Tesseract для OCR + GPT-4o-mini для структурирования

1. Tesseract извлекает сырой текст (~0.5-2 сек, бесплатно)
2. GPT-4o-mini структурирует текст в JSON (~1-2 сек, дешевле Vision в 10 раз)
3. Fallback на полный Vision анализ при неудаче

**Преимущества:**

- **Дешевизна:**
  - Tesseract OCR: бесплатно (open-source)
  - Хостинг: ~$0-5/мес на Fly.io → **практически бесплатно**
  - GPT-4o-mini для структурирования: ~$0.0005 за чек
  - **Итого: ~$0.0005-0.001 за чек** vs $0.01-0.02 для Vision (в 10-40 раз дешевле)
- Скорость: сопоставима с Vision
- Надежность: fallback на Vision при неудаче

## Порог уверенности

- `store_confidence >= 0.8`: автоматическое принятие
- `0.5 <= store_confidence < 0.8`: показать подтверждение в UI
- `store_confidence < 0.5`: предложить выбрать магазин вручную

## Квоты/очередь

- Таблица `usage_daily_quota` для трекинга (пока не используется)
- Таблица `processing_jobs` для очереди (заготовка для масштабирования)
- Ретраи с exponential backoff (3 попытки, макс. 30 сек timeout)
