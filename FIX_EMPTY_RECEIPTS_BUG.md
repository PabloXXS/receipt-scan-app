# Исправление бага с пустыми чеками

## Описание проблемы

При выборе изображения из галереи/камеры, нажатии "Анализировать", получении ошибки и последующей отмене добавлялся пустой чек в список чеков. Также проблема возникала при анализе по ссылке.

## Причина

Edge Function `analyze` создает чек в БД сразу со статусом `processing` (строка 1029-1041 в `supabase/functions/analyze/index.ts`), **до** успешного завершения обработки. Если возникает ошибка или пользователь отменяет процесс, чек уже существует в БД.

Кроме того, в `receiptsRepository.getAllReceipts()` отсутствовал фильтр по статусу, что приводило к показу всех чеков, включая `processing` и `failed`.

## Решение

### 1. Фильтрация чеков по статусу

**Файл:** `lib/repositories/receipts_repository.dart`

- Добавлен фильтр `.eq('status', 'ready')` в метод `getAllReceipts()`
- Теперь в списке чеков показываются только успешно обработанные чеки

### 2. Отслеживание и очистка незавершенных чеков

**Файл:** `lib/models/receipt_wizard_state.dart`

- Добавлено поле `receiptId` для хранения ID созданного чека

**Файл:** `lib/providers/receipt_wizard_provider.dart`

- При успешном вызове `analyze` сохраняется `receiptId` в состоянии
- При ошибке анализа чек удаляется из БД (метод `_deleteFailedReceipt`)
- Добавлен метод `cancelAndCleanup()` для очистки при отмене wizard
- Метод `_deleteFailedReceipt()` проверяет статус чека и удаляет только `processing` или `failed`

**Файл:** `lib/pages/receipt_wizard_page.dart`

- Кнопка "Отмена" теперь вызывает `cancelAndCleanup()` вместо `clearState()`
- Обновлены сигнатуры `onCancel` для поддержки async операций

### 3. Очистка существующих проблемных чеков

**Файл:** `cleanup_failed_receipts.sql`

- SQL-скрипт для удаления существующих чеков в статусах `processing` или `failed`

## Применение исправления

1. Код уже обновлен и сгенерирован через `build_runner`

2. Для очистки существующих "мусорных" чеков выполните:

   ```bash
   # Локально через Supabase CLI
   supabase db execute --file cleanup_failed_receipts.sql --linked

   # Или через веб-интерфейс Supabase SQL Editor
   ```

3. Перезапустите приложение для применения изменений

## Результат

- ✅ В списке чеков показываются только готовые чеки
- ✅ При ошибке анализа чек автоматически удаляется из БД
- ✅ При отмене wizard незавершенный чек очищается
- ✅ Нет больше "пустых" чеков в списке

## Тестирование

1. Выбрать изображение из галереи
2. Нажать "Анализировать"
3. Дождаться ошибки (или симулировать её)
4. Нажать "Отмена"
5. Проверить, что в списке чеков не появился пустой/проблемный чек
