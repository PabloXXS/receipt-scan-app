# Настройка полностью бесплатного режима

> 🎉 Приложение может работать **100% бесплатно** с использованием только open-source инструментов!

## 🆓 Бесплатный стек

| Компонент          | Решение                 | Лимиты               | Стоимость |
| ------------------ | ----------------------- | -------------------- | --------- |
| **OCR Engine**     | Tesseract (open-source) | Нет лимитов          | **$0**    |
| **Хостинг OCR**    | Fly.io Free Tier        | 3 VMs, 256MB RAM     | **$0**    |
| **Fallback OCR**   | OCR.space Free Plan     | 25,000 запросов/мес  | **$0**    |
| **База данных**    | Supabase Free Tier      | 500MB, 2GB transfer  | **$0**    |
| **Storage**        | Supabase Storage        | 1GB                  | **$0**    |
| **Auth**           | Supabase Auth           | Unlimited users      | **$0**    |
| **Edge Functions** | Supabase Functions      | 500k invocations/мес | **$0**    |

**ИТОГО:** Полностью бесплатно до ~15,000 чеков/месяц! 🚀

---

## 📋 Инструкция по настройке

### 1. Деплой Tesseract на Fly.io (бесплатно)

```bash
# Установка Fly.io CLI
curl -L https://fly.io/install.sh | sh

# Логин (создайте бесплатный аккаунт)
flyctl auth login

# Деплой Tesseract сервиса
cd supabase/functions/_shared/tesseract-service

# Создание приложения с минимальными ресурсами
flyctl launch --name tesseract-ocr-receipt \
  --region ams \
  --vm-size shared-cpu-1x \
  --vm-memory 256

# При запросе:
# - Add Postgres? → No
# - Add Redis? → No
# - Deploy now? → Yes

# Проверка статуса
flyctl status

# Получение URL
flyctl info
# Output: https://tesseract-ocr-receipt.fly.dev
```

**Fly.io Free Tier:**

- ✅ 3 shared-cpu-1x VMs (256MB RAM)
- ✅ 160GB outbound transfer/месяц
- ✅ Scale to zero: не работает → не платишь
- ✅ Достаточно для 15,000-30,000 чеков/месяц

### 2. Получить бесплатный API ключ OCR.space (опционально)

OCR.space как резервный fallback:

1. Перейти на https://ocr.space/ocrapi
2. Нажать "Register for free API key"
3. Заполнить форму (бесплатный план)
4. Получить ключ в email

**OCR.space Free Tier:**

- ✅ 25,000 запросов/месяц
- ✅ Без кредитной карты
- ✅ Tesseract Engine 2 (более точный)

### 3. Настроить Supabase на бесплатный режим

```bash
# В корне проекта

# Установить Tesseract как primary провайдер
supabase secrets set AI_PROVIDER=tesseract

# URL задеплоенного Tesseract сервиса
supabase secrets set TESSERACT_OCR_URL=https://tesseract-ocr-receipt.fly.dev

# OCR.space ключ как fallback (опционально, но рекомендуется)
supabase secrets set OCR_SPACE_API_KEY=your_free_api_key_here

# УДАЛИТЬ OpenAI ключ (больше не нужен)
supabase secrets unset OPENAI_API_KEY

# Проверить настройки
supabase secrets list

# Деплой обновленной функции
supabase functions deploy analyze

# Проверить логи
supabase functions logs analyze --tail
```

### 4. Проверка работы бесплатного режима

```bash
# Тест health check Tesseract
curl https://tesseract-ocr-receipt.fly.dev/health

# Ожидаемый ответ:
# {
#   "status": "healthy",
#   "timestamp": "2024-01-15T12:00:00.000Z",
#   "uptime": 123.45,
#   "service": "tesseract-ocr-api"
# }
```

Через Flutter приложение:

1. Загрузить тестовый чек
2. Проверить логи в Supabase Dashboard
3. Должно быть: `[ANALYZE] Используем Tesseract как основной метод`

---

## 🔄 Логика работы в бесплатном режиме

```
┌─────────────────────────────────────────────┐
│  Загрузка изображения чека                  │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  1. Tesseract OCR (primary)                 │
│     - Бесплатный open-source                │
│     - Предобработка изображения             │
│     - Распознавание текста                  │
└────────────────┬────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  2. Текстовый парсер                        │
│     - Извлечение товаров                    │
│     - Определение валюты (18 паттернов)     │
│     - Парсинг даты/времени                  │
│     - Расчет суммы                          │
└────────────────┬────────────────────────────┘
                 ↓
         Результат полезный?
                 │
        ┌────────┴────────┐
        │                 │
       ✅ Да             ❌ Нет
        │                 │
        │                 ↓
        │    ┌────────────────────────────┐
        │    │ 3. OCR.space (fallback)    │
        │    │    - Бесплатно до 25k/мес  │
        │    │    - Альтернативный OCR     │
        │    └────────────┬───────────────┘
        │                 │
        └────────┬────────┘
                 ↓
┌─────────────────────────────────────────────┐
│  Сохранение в БД                            │
│  - receipts                                 │
│  - receipt_items                            │
└─────────────────────────────────────────────┘
```

**Особенности:**

- ❌ **НЕ используется OpenAI Vision** (экономия $0.01-0.02 на чек)
- ✅ **Tesseract** распознает текст бесплатно
- ✅ **Текстовый парсер** структурирует данные
- ✅ **OCR.space** как резервный вариант (25k бесплатно)

---

## 📊 Ограничения бесплатного режима

### По сравнению с OpenAI Vision:

| Аспект                        | Бесплатный режим | OpenAI Vision  |
| ----------------------------- | ---------------- | -------------- |
| **Точность на хороших чеках** | ★★★★☆ (90-95%)   | ★★★★★ (95-99%) |
| **Точность на плохих чеках**  | ★★☆☆☆ (60-70%)   | ★★★★☆ (85-90%) |
| **Скорость**                  | 1-3 сек          | 1-2 сек        |
| **Стоимость**                 | **$0**           | $0.01-0.02/чек |
| **Определение магазина**      | ★★★☆☆            | ★★★★★          |
| **Сложные форматы**           | ★★★☆☆            | ★★★★★          |

### Когда бесплатный режим работает отлично:

✅ Четкие фотографии чеков  
✅ Хорошее освещение  
✅ Прямой угол съемки  
✅ Стандартные форматы чеков (магазины РФ)  
✅ Контрастный текст

### Когда могут быть проблемы:

⚠️ Размытые фото  
⚠️ Плохое освещение  
⚠️ Неровные чеки (мятые, порванные)  
⚠️ Нестандартные форматы (рукописные, необычные шрифты)  
⚠️ Низкое разрешение камеры

---

## 💡 Советы для лучшего качества в бесплатном режиме

### Для пользователей (добавить в UI hints):

1. 📸 **Фотографируйте при хорошем освещении**
2. 📐 **Держите телефон прямо над чеком**
3. 🔍 **Чек должен занимать весь кадр**
4. ✨ **Разгладьте чек перед фото**
5. 🎯 **Убедитесь, что текст в фокусе**

### Для разработчиков:

1. Включите предобработку: `preprocess: true` (по умолчанию)
2. Используйте PSM mode 6 для чеков (по умолчанию)
3. Добавьте в UI кнопку "Повторить распознавание" при низком confidence
4. Показывайте пользователю качество распознавания (confidence)

---

## 🔧 Улучшения для бесплатного режима (опционально)

### 1. Предобработка изображений на клиенте

Добавить в Flutter приложение перед загрузкой:

- Конвертация в grayscale
- Увеличение контраста
- Обрезка по границам чека
- Коррекция перспективы

### 2. Ручная коррекция после распознавания

UI для редактирования:

- Название магазина (если confidence < 0.8)
- Сумма (если не совпадает с суммой позиций)
- Товары (добавление/удаление)

### 3. Feedback loop для улучшения парсера

Собирать статистику:

- Какие паттерны чеков распознаются плохо
- Какие магазины чаще всего требуют коррекции
- Обновлять regex паттерны на основе данных

---

## 📈 Масштабирование бесплатного режима

### Текущие лимиты:

**Fly.io Free Tier:**

- 3 VMs × 256MB = 768MB RAM
- ~15,000-30,000 чеков/месяц
- При необходимости: scale up (~$5-10/мес)

**OCR.space Free Tier:**

- 25,000 запросов/месяц
- Используется только как fallback

**Supabase Free Tier:**

- 500MB DB (достаточно для ~50,000 чеков)
- 1GB Storage (достаточно для ~5,000 изображений)
- 2GB transfer/месяц

### Если превысили лимиты:

#### Вариант 1: Платный Fly.io (~$5-10/мес)

```bash
# Увеличить ресурсы
flyctl scale vm shared-cpu-2x --memory 512
```

#### Вариант 2: Добавить кэширование

- Кэшировать результаты OCR для дубликатов
- Проверять MD5 хэш изображения перед обработкой

#### Вариант 3: Self-hosted (полностью бесплатно)

- VPS на домашнем сервере / Raspberry Pi
- Или использовать Oracle Cloud Free Tier (forever free)

---

## ✅ Checklist перехода на бесплатный режим

- [ ] Создан аккаунт на Fly.io
- [ ] Задеплоен Tesseract сервис на Fly.io
- [ ] Получен URL Tesseract: `https://tesseract-ocr-receipt.fly.dev`
- [ ] Health check работает: `curl https://...fly.dev/health`
- [ ] (Опционально) Получен бесплатный ключ OCR.space
- [ ] Установлены переменные в Supabase:
  - [ ] `AI_PROVIDER=tesseract`
  - [ ] `TESSERACT_OCR_URL=https://...`
  - [ ] `OCR_SPACE_API_KEY=...` (если есть)
- [ ] Удален `OPENAI_API_KEY` из Supabase
- [ ] Задеплоена функция: `supabase functions deploy analyze`
- [ ] Протестирована загрузка чека через приложение
- [ ] Проверены логи: должно быть "Используем Tesseract"
- [ ] Качество распознавания приемлемое (>85% на хороших фото)

---

## 🎯 Итоговая стоимость

### Для малого бизнеса (до 15,000 чеков/месяц):

```
Tesseract на Fly.io: $0 (free tier)
OCR.space fallback:  $0 (free tier, до 25k)
Supabase:            $0 (free tier)
─────────────────────────
ИТОГО:               $0/месяц 💰
```

### Для среднего бизнеса (30,000 чеков/месяц):

```
Tesseract на Fly.io: ~$5/мес (scale up)
OCR.space fallback:  $0 (редко используется)
Supabase:            $0 (free tier достаточно)
─────────────────────────
ИТОГО:               ~$5/месяц 💰
```

**vs OpenAI Vision для 30,000 чеков:**

```
OpenAI Vision: 30,000 × $0.015 = $450/месяц
```

**Экономия: $445/месяц = $5,340/год! 🎉**

---

## 📞 Поддержка

Если возникли проблемы:

1. Проверьте логи Fly.io: `flyctl logs`
2. Проверьте логи Supabase: `supabase functions logs analyze --tail`
3. Проверьте health check: `curl https://...fly.dev/health`
4. Убедитесь, что переменные установлены: `supabase secrets list`

---

💡 **Совет:** Начните с бесплатного режима. Если качество не устраивает — всегда можно вернуться к OpenAI Vision (просто изменить `AI_PROVIDER=openai`).

🚀 **Готово!** Теперь у вас полностью бесплатное решение для распознавания чеков!
